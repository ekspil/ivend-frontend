<template>
	<form name="notifications" action="POST" v-if="profile">
		<div class="text-wrap">
			<div class="example top-buttons-container top-buttons">
				<div class="top-buttons__right-container submit-button">
					<Hint ref="notificationsHint" className="hint" />
					<div class="row gutters-xs">
						<span class="col-auto">
							<button class="btn btn-primary" type="button" @click.prevent="save">Сохранить</button>
						</span>
					</div>
				</div>
			</div>
		</div>
		<div class="table-responsive notification-table">
			<table class="table card-table table-vcenter text-nowrap notification-table">
				<thead>
					<tr>
						<th>Событие</th>
						<th>Email</th>
						<!--
						<th>Viber</th>
						<th>Whatsapp</th>
						<th>Telegram</th>
						-->
						<th>SMS</th>
					</tr>
				</thead>
				<tbody>

					<tr v-for="({ type, email, sms }, index) in profile.notificationSettings" :key="index">
						<td>Нет связи с автоматом</td>

						<td class="checkbox-cel">
							<label class="default-checkbox" for="checkbox-11">
								<input class="auth-block__checkbox" type="checkbox"
								id="checkbox-11" v-model="profile.notificationSettings[index].email">

								<span class="auth-block__checkbox-label"></span>
							</label>
						</td>
						<td class="checkbox-cel">
							<label class="default-checkbox" for="checkbox-12">
								<input class="auth-block__checkbox" type="checkbox"
								id="checkbox-12" v-model="profile.notificationSettings[index].sms">

								<span class="auth-block__checkbox-label"></span>
							</label>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
	</form>
</template>

<script>
	import gql from 'graphql-tag';

	import { isEmpty } from 'ramda';
	import { convertServerError } from '@/utils';

	import Hint from '@/modules/Hint';

	export default {
		name: 'Notifications',
		components: {
			Hint
		},
		apollo: {
			profile: {
				query: gql`
					query {
						getProfile {
							email,
							phone,
							notificationSettings {
								type,
								email,
								sms
							}
						}
					}
				`,
				update: data => data.getProfile
			}
		},
		data: () => ({
			profile: null
		}),
		methods: {
			async save () {
				const notification = this.profile.notificationSettings[0];

				try {
					const { errors } = await this.$apollo.mutate({
						mutation: gql`
						mutation EditSettings ($data: UpdateNotificationSettingInput!) {
							updateNotificationSetting(input: $data) {
								type
							}
						}
						`,
						variables: {
							data: {
								type: notification.type,
								email: notification.email,
								sms: notification.sms
							}
						}
					});

					if (errors && !isEmpty(errors)) {
						const error = head(errors).message || 'Ошибка сервера.';
						this.$refs.notificationsHint.show(convertServerError(error));
					} else {
						this.$refs.notificationsHint.show('Сохранено');
					}
				} catch (error) {
					this.$refs.notificationsHint.show(convertServerError(error.message));
				}
			}
		}
	}
</script>

<style scoped lang="scss">
	.top-buttons {
		justify-content: flex-end;

		.submit-button {
			position: relative;
		}
	}
</style>
